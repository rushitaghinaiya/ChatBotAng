<!-- icare-chatbot.component.html -->
<div class="chatbot-container">
  <!-- Header -->
  <div class="chatbot-header">
    <div class="header-content">
      <div class="icon-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
      </div>
      <div class="header-text">
        <h1>iCare Life Assistant</h1>
        <p>Your Caregiving Journey Starts Here</p>
      </div>
      <div class="voice-controls" *ngIf="browserSupportsVoice">
        <button class="voice-toggle" (click)="toggleVoice()" [title]="voiceEnabled ? 'Disable voice' : 'Enable voice'"
          [ngClass]="{'voice-off': !voiceEnabled}">
          <svg *ngIf="voiceEnabled" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
          </svg>
          <svg *ngIf="!voiceEnabled" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line x1="23" y1="9" x2="17" y2="15"></line>
            <line x1="17" y1="9" x2="23" y2="15"></line>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Voice Status Indicator -->
  <div class="voice-status" *ngIf="isListening || isSpeaking">
    <div class="status-indicator" [ngClass]="{'listening': isListening, 'speaking': isSpeaking}">
      <span *ngIf="isListening">ðŸŽ¤ Listening...</span>
      <span *ngIf="isSpeaking">ðŸ”Š Speaking...</span>
    </div>
  </div>

  <!-- Messages Container -->
  <div class="messages-container" #scrollContainer>
    <div *ngFor="let message of messages; let last = last" class="message-wrapper"
      [ngClass]="{'user-message': message.type === 'user'}">

      <!-- ðŸ‘¤ Show name for both user and bot -->
      <div class="sender-name">
        {{ message.type === 'user' ? message.senderName || 'You' : 'Bot' }}
      </div>

      <!-- ðŸ’¬ Message bubble -->
      <!-- Replace the message bubble section in your template with this enhanced version -->
      <div class="message-bubble"
        [ngClass]="{'user-bubble': message.type === 'user', 'bot-bubble': message.type === 'bot'}">

        <!-- Regular message display (for messages without multiple answers) -->
        <div *ngIf="message.text !== 'thinking' && !message.hasMultipleAnswers" class="message-text"
          [id]="last ? 'lastMessage' : null" [innerHTML]="formatMessage(message.text)">
        </div>

        <!-- Enhanced display for messages with multiple answers -->
        <div *ngIf="message.text !== 'thinking' && message.hasMultipleAnswers" class="message-text"
          [id]="last ? 'lastMessage' : null">

          <!-- Always show first answer -->
          <div class="answer-item" *ngIf="message.answers && message.answers.length > 0">
            <div class="answer-content" [innerHTML]="formatMessage(message.answers[0].response)"></div>
            <div class="answer-reference">
              <small><strong>Ref:</strong> {{ message.answers[0].source }}</small>
            </div>
          </div>

          <!-- Show additional answers when expanded -->
          <div *ngIf="message.isExpanded && message.answers && message.answers.length > 1" class="additional-answers">
            <div class="answer-item" *ngFor="let answer of message.answers.slice(1); let i = index">
              <div class="answer-separator"></div>
              <div class="answer-content" [innerHTML]="formatMessage(answer.response)"></div>
              <div class="answer-reference">
                <small><strong>Ref:</strong> {{ answer.source }}</small>
              </div>
            </div>
          </div>

          <!-- Toggle button for multiple answers -->
          <div *ngIf="message.hasMultipleAnswers" class="toggle-container">
            <button class="toggle-button" (click)="toggleAnswerExpansion(messages.indexOf(message))">
              <span *ngIf="!message.isExpanded" class="toggle-text">
                ðŸ“– Read More ({{ message.answers!.length - 1 }} more answer{{ message.answers!.length > 2 ? 's' : '' }})
              </span>
              <span *ngIf="message.isExpanded" class="toggle-text">
                ðŸ“– Show Less
              </span>
            </button>
          </div>
        </div>

        <!-- Typing indicator (unchanged) -->
        <div *ngIf="message.text === 'thinking'" class="typing-dots">
          <span>.</span><span>.</span><span>.</span>
        </div>
      </div>

      <!-- ðŸ§  Options (if any) -->
      <div *ngIf="message.options" class="options-container">
        <button *ngFor="let option of message.options" class="option-button"
          [ngClass]="{ 'lang-option':option.value.startsWith('langs') }" (click)="handleOptionClick(option)">
          <span class="option-icon">{{ getOptionIcon(option) }}</span>
          <span>{{ getOptionLabel(option) }}</span>
        </button>
      </div>

      <!-- ðŸ•“ Timestamp -->
      <div class="timestamp">{{ message.timestamp }}</div>
    </div>
  </div>



  <!-- Input Container -->
  <div class="input-container">
    <div class="input-wrapper">
      <input type="text" [(ngModel)]="userInput" (keypress)="onKeyPress($event)" placeholder="Type your message..."
        class="message-input" [disabled]="isListening">
      <button *ngIf="browserSupportsVoice" (click)="toggleVoiceInput()" class="voice-button"
        [ngClass]="{'active': isListening}" [disabled]="isSpeaking" title="Click to use voice input">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
          <line x1="12" y1="19" x2="12" y2="23"></line>
          <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
      </button>
      <button (click)="onSubmit()" [disabled]="!userInput.trim() || isListening" class="send-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>